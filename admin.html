<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - In.dl</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #d62976;
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --success: #00ff88;
            --warning: #ffb800;
            --danger: #ff0033;
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-glass: rgba(0, 0, 0, 0.03);
            --border: rgba(0, 0, 0, 0.1);
            --text-primary: #000000;
            --text-secondary: #555555;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .admin-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 30px 20px;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }

        .admin-logo {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), #fda75b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-section {
            margin-bottom: 30px;
        }

        .nav-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 15px;
            padding-left: 15px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-secondary);
            text-decoration: none;
            margin-bottom: 5px;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--bg-glass);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item i {
            width: 24px;
            text-align: center;
        }

        .badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        /* Main Content */
        .main-content {
            padding: 30px;
            overflow-y: auto;
            max-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 800;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: var(--bg-glass); color: var(--text-primary); border: 1px solid var(--border); }

        .btn:hover { transform: translateY(-2px); opacity: 0.9; }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 25px;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: rgba(214, 41, 118, 0.1);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .stat-change {
            font-size: 0.85rem;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--danger); }

        /* Content Cards */
        .card {
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 700;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        .data-table td {
            padding: 15px 12px;
            border-bottom: 1px solid var(--border);
        }

        .data-table tr:hover td {
            background: var(--bg-glass);
        }

        .user-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
        }

        .plan-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .plan-free { background: #333; color: #fff; }
        .plan-booster { background: #4a90e2; color: #fff; }
        .plan-god { background: linear-gradient(135deg, #ffd700, #ffb700); color: #000; }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-pending { background: rgba(255, 184, 0, 0.2); color: var(--warning); }
        .status-approved { background: rgba(0, 255, 136, 0.2); color: var(--success); }
        .status-rejected { background: rgba(255, 0, 51, 0.2); color: var(--danger); }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        .tab {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .tab:hover { color: var(--text-primary); }
        .tab.active { background: var(--primary); color: white; }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 25px;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        @media (max-width: 768px) {
            .admin-layout { grid-template-columns: 1fr; }
            .sidebar { display: none; }
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <aside class="sidebar">
            <div class="admin-logo">
                <i class="fas fa-shield-alt"></i>
                Admin Panel
            </div>
            
            <div class="nav-section">
                <div class="nav-title">Main</div>
                <a href="#" class="nav-item active" onclick="showSection('dashboard')">
                    <i class="fas fa-chart-line"></i>
                    Dashboard
                </a>
                <a href="#" class="nav-item" onclick="showSection('users')">
                    <i class="fas fa-users"></i>
                    Users
                    <span class="badge" id="userCountBadge">0</span>
                </a>
                <a href="#" class="nav-item" onclick="showSection('payments')">
                    <i class="fas fa-credit-card"></i>
                    Payments
                    <span class="badge" id="paymentBadge">0</span>
                </a>
                <a href="#" class="nav-item" onclick="showSection('tickets')">
                    <i class="fas fa-headset"></i>
                    Support
                    <span class="badge" id="ticketBadge">0</span>
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-title">System</div>
                <a href="#" class="nav-item" onclick="showSection('settings')">
                    <i class="fas fa-cog"></i>
                    Settings
                </a>
                <a href="#" class="nav-item" onclick="showSection('bans')">
                    <i class="fas fa-ban"></i>
                    Bans
                </a>
                <a href="/" class="nav-item">
                    <i class="fas fa-arrow-left"></i>
                    Back to Site
                </a>
            </div>
        </aside>

        <main class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard-section">
                <div class="header">
                    <div>
                        <h1>Dashboard</h1>
                        <p style="color: var(--text-secondary);">Welcome back, Administrator</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon"><i class="fas fa-users"></i></div>
                            <span class="stat-change positive"><i class="fas fa-arrow-up"></i> 12%</span>
                        </div>
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background: rgba(0, 255, 136, 0.1); color: var(--success);">
                                <i class="fas fa-download"></i>
                            </div>
                            <span class="stat-change positive"><i class="fas fa-arrow-up"></i> 8%</span>
                        </div>
                        <div class="stat-value" id="todayDownloads">0</div>
                        <div class="stat-label">Downloads Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background: rgba(255, 184, 0, 0.1); color: var(--warning);">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="pendingPayments">0</div>
                        <div class="stat-label">Pending Payments</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon" style="background: rgba(255, 0, 51, 0.1); color: var(--danger);">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="openTickets">0</div>
                        <div class="stat-label">Open Tickets</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Download Analytics (30 Days)</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="analyticsChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Users</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Plan</th>
                                <th>Credits</th>
                                <th>Joined</th>
                            </tr>
                        </thead>
                        <tbody id="recentUsersTable">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Users Section -->
            <div id="users-section" style="display:none;">
                <div class="header">
                    <h1>User Management</h1>
                    <div class="header-actions">
                        <input type="text" placeholder="Search users..." class="form-input" style="width:300px;" id="userSearch">
                    </div>
                </div>
                
                <div class="card">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Email</th>
                                <th>Plan</th>
                                <th>Credits</th>
                                <th>Downloads</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Payments Section -->
            <div id="payments-section" style="display:none;">
                <div class="header">
                    <h1>Payment Requests</h1>
                </div>
                
                <div class="tabs">
                    <div class="tab active" onclick="loadPayments('pending')">Pending</div>
                    <div class="tab" onclick="loadPayments('approved')">Approved</div>
                    <div class="tab" onclick="loadPayments('rejected')">Rejected</div>
                </div>
                
                <div class="card">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Plan</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTable">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings-section" style="display:none;">
                <div class="header">
                    <h1>System Settings</h1>
                </div>
                
                <div class="card">
                    <h3 class="card-title" style="margin-bottom:20px;">Site Configuration</h3>
                    <div class="form-group">
                        <label class="form-label">Site Name</label>
                        <input type="text" class="form-input" id="siteName" value="In.dl">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Global Announcement</label>
                        <input type="text" class="form-input" id="globalAnnouncement" placeholder="Enter announcement text...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="maintenanceMode"> Maintenance Mode
                        </label>
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API = '/api/admin';
        let authToken = localStorage.getItem('indl_token');
        let analyticsChart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (!authToken) {
                window.location.href = '/';
                return;
            }
            loadDashboard();
        });

        function showSection(section) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            ['dashboard', 'users', 'payments', 'tickets', 'settings', 'bans'].forEach(s => {
                const el = document.getElementById(s + '-section');
                if (el) el.style.display = 'none';
            });
            
            const target = document.getElementById(section + '-section');
            if (target) {
                target.style.display = 'block';
                // Load section data
                if (section === 'users') loadUsers();
                if (section === 'payments') loadPayments('pending');
                if (section === 'dashboard') loadDashboard();
            }
        }

        async function loadDashboard() {
            try {
                const res = await fetch(`${API}/dashboard`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                
                if (res.ok) {
                    document.getElementById('totalUsers').textContent = data.stats.total_users;
                    document.getElementById('todayDownloads').textContent = data.stats.today_downloads;
                    document.getElementById('pendingPayments').textContent = data.stats.pending_payments;
                    document.getElementById('openTickets').textContent = data.stats.open_tickets;
                    
                    document.getElementById('userCountBadge').textContent = data.stats.total_users;
                    document.getElementById('paymentBadge').textContent = data.stats.pending_payments;
                    document.getElementById('ticketBadge').textContent = data.stats.open_tickets;
                    
                    // Recent users table
                    const tbody = document.getElementById('recentUsersTable');
                    tbody.innerHTML = data.recent_users.map(u => `
                        <tr>
                            <td>
                                <div class="user-cell">
                                    <div class="avatar">${u.username[0].toUpperCase()}</div>
                                    <div>
                                        <div style="font-weight:700">${u.username}</div>
                                        <div style="font-size:0.85rem;color:var(--text-secondary)">${u.email || 'No email'}</div>
                                    </div>
                                </div>
                            </td>
                            <td><span class="plan-badge plan-${u.plan.toLowerCase().replace(' ', '-')}">${u.plan}</span></td>
                            <td>${u.tokens === 999999 ? '∞' : u.tokens}</td>
                            <td>${new Date(u.created_at).toLocaleDateString()}</td>
                        </tr>
                    `).join('');
                    
                    // Render chart
                    renderChart(data.analytics);
                }
            } catch (e) {
                console.error('Failed to load dashboard:', e);
            }
        }

        function renderChart(analytics) {
            const ctx = document.getElementById('analyticsChart').getContext('2d');
            
            if (analyticsChart) {
                analyticsChart.destroy();
            }
            
            const dates = analytics.map(a => new Date(a.date).toLocaleDateString());
            const downloads = analytics.map(a => a.total_downloads);
            
            analyticsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Downloads',
                        data: downloads,
                        borderColor: '#d62976',
                        backgroundColor: 'rgba(214, 41, 118, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#888' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#888' }
                        }
                    }
                }
            });
        }

        async function loadUsers(page = 1) {
            try {
                const res = await fetch(`${API}/users?page=${page}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                
                if (res.ok) {
                    const tbody = document.getElementById('usersTable');
                    tbody.innerHTML = data.users.map(u => `
                        <tr>
                            <td>
                                <div class="user-cell">
                                    <div class="avatar">${u.username[0].toUpperCase()}</div>
                                    <div style="font-weight:700">${u.username}</div>
                                </div>
                            </td>
                            <td>${u.email || '-'}</td>
                            <td><span class="plan-badge plan-${u.plan.toLowerCase().replace(' ', '-')}">${u.plan}</span></td>
                            <td>${u.tokens === 999999 ? '∞' : u.tokens}</td>
                            <td>${u.total_downloads || 0}</td>
                            <td>
                                <button class="btn btn-secondary" style="padding:6px 12px;" onclick="editUser(${u.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger" style="padding:6px 12px;" onclick="banUser(${u.id})">
                                    <i class="fas fa-ban"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (e) {
                console.error('Failed to load users:', e);
            }
        }

        async function loadPayments(status) {
            try {
                const res = await fetch(`${API}/payments?status=${status}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                
                if (res.ok) {
                    const tbody = document.getElementById('paymentsTable');
                    tbody.innerHTML = data.payments.map(p => `
                        <tr>
                            <td>
                                <div style="font-weight:700">${p.username}</div>
                                <div style="font-size:0.85rem;color:var(--text-secondary)">${p.email}</div>
                            </td>
                            <td>${p.plan_name}</td>
                            <td>₹${p.amount}</td>
                            <td>${new Date(p.created_at).toLocaleDateString()}</td>
                            <td><span class="status-badge status-${p.status}">${p.status}</span></td>
                            <td>
                                ${p.status === 'pending' ? `
                                    <button class="btn btn-primary" style="padding:6px 12px;" onclick="processPayment(${p.id}, 'approve')">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                    <button class="btn btn-danger" style="padding:6px 12px;" onclick="processPayment(${p.id}, 'reject')">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                ` : '-'}
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (e) {
                console.error('Failed to load payments:', e);
            }
        }

        async function processPayment(id, action) {
            if (!confirm(`Are you sure you want to ${action} this payment?`)) return;
            
            try {
                const res = await fetch(`${API}/payment/process`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ payment_id: id, action })
                });
                
                if (res.ok) {
                    loadPayments('pending');
                    loadDashboard();
                }
            } catch (e) {
                alert('Failed to process payment');
            }
        }

        async function saveSettings() {
            const settings = {
                site_name: document.getElementById('siteName').value,
                announcement: document.getElementById('globalAnnouncement').value,
                maintenance: document.getElementById('maintenanceMode').checked
            };
            
            try {
                const res = await fetch(`${API}/settings`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                if (res.ok) {
                    alert('Settings saved');
                }
            } catch (e) {
                alert('Failed to save settings');
            }
        }

        function refreshData() {
            loadDashboard();
        }

        function editUser(id) {
            // Implementation for user editing modal
            alert('Edit user ' + id);
        }

        function banUser(id) {
            if (confirm('Ban this user?')) {
                // Implementation
            }
        }
    </script>
</body>
</html>
