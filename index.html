<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In.dl - Premium Downloader</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --bg-deep: #000000; --primary: #d62976; --glass: rgba(20, 20, 20, 0.9); --border: rgba(255, 255, 255, 0.15); --text-main: #ffffff; --text-dim: #888; --font: 'Segoe UI', Roboto, sans-serif; --gold: #ffd700; --success: #00ff88; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font); }
        body { background-color: var(--bg-deep); background-image: radial-gradient(circle at 50% 50%, #111 0%, #000 100%); color: var(--text-main); min-height: 100vh; overflow-x: hidden; }
        .void-stream { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .stream-icon { position: absolute; color: rgba(255, 255, 255, 0.08); font-size: 2.5rem; animation: floatRise linear infinite; }
        @keyframes floatRise { 0% { transform: translateY(110vh) scale(0.8) rotate(0deg); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-10vh) scale(1.5) rotate(360deg); opacity: 0; } }
        
        #announcementBar { background: var(--primary); color: white; text-align: center; padding: 8px; font-weight: bold; font-size: 0.9rem; display: none; z-index: 200; position: relative; }
        
        header { background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); padding: 20px 0; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .nav-container { max-width: 1200px; margin: 0 auto; padding: 0 25px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.8rem; font-weight: 900; letter-spacing: -1px; display: flex; align-items: center; gap: 12px; }
        .logo i { color: var(--primary); }
        
        .user-nav { display: flex; gap: 20px; align-items: center; }
        .profile-wrap { position: relative; display: inline-block; }
        .profile-btn { width: 45px; height: 45px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; font-size: 1.2rem; }
        .profile-btn:hover { border-color: var(--primary); background: var(--glass); }
        .dropdown-menu { position: absolute; right: 0; top: 120%; width: 220px; background: #0a0a0a; border: 1px solid #333; border-radius: 15px; padding: 20px; display: none; flex-direction: column; gap: 10px; z-index: 1000; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        .dropdown-menu.show { display: flex; }
        
        .token-pill { background: rgba(255,255,255,0.08); border: 1px solid var(--border); padding: 8px 16px; border-radius: 50px; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: 0.3s; }
        .token-pill i { color: gold; }
        
        .liquid-btn { background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 50px; font-weight: 700; cursor: pointer; transition: 0.3s; display: inline-flex; align-items: center; justify-content: center; }
        .liquid-btn:hover { transform: scale(1.05); }
        .liquid-btn:disabled { background: #555; cursor: not-allowed; }
        
        .container { max-width: 1000px; margin: 0 auto; padding: 60px 20px; }
        .hero { text-align: center; margin-bottom: 60px; }
        .hero h1 { font-size: 4rem; font-weight: 900; margin-bottom: 15px; }
        .hero p { color: var(--text-dim); font-size: 1.2rem; }
        
        .search-container { margin-bottom: 50px; }
        .search-bar { background: rgba(20,20,20,0.9); border: 1px solid var(--border); border-radius: 20px; padding: 8px; display: flex; align-items: center; transition: 0.3s; }
        .search-bar:focus-within { border-color: var(--primary); }
        .paste-icon { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; color: #555; cursor: pointer; font-size: 1.2rem; }
        .url-inp { flex: 1; background: transparent; border: none; padding: 0 20px; font-size: 1.2rem; color: white; outline: none; height: 50px; }
        .go-btn { background: var(--primary); color: white; border: none; width: 60px; height: 50px; border-radius: 14px; cursor: pointer; font-size: 1.2rem; }
        
        .dark-card { background: var(--glass); border: 1px solid var(--border); border-radius: 20px; padding: 30px; margin-bottom: 30px; display: none; }
        .res-top { display: flex; gap: 25px; margin-bottom: 25px; border-bottom: 1px solid var(--border); padding-bottom: 25px; }
        .res-img { width: 160px; height: 160px; object-fit: cover; border-radius: 12px; background: #111; }
        .fmt-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; background: rgba(255,255,255,0.03); border-radius: 12px; }
        .dl-mini-btn { background: white; color: black; border: none; padding: 8px 20px; border-radius: 8px; font-weight: 800; cursor: pointer; }
        .dl-mini-btn:hover { background: var(--primary); color: white; }
        
        /* Modals */
        .modal-wrap { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: #111; padding: 40px; width: 90%; max-width: 400px; border-radius: 20px; border: 1px solid #333; text-align: center; position: relative; }
        .modal-inp { width: 100%; padding: 15px; background: #000; border: 1px solid #333; color: white; margin: 10px 0; border-radius: 12px; outline: none; }
        
        /* Payment Modal */
        #planModal .modal-box { max-width: 900px; background: transparent; border: none; }
        .pricing-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .plan-card { background: #0a0a0a; border: 1px solid #333; border-radius: 20px; padding: 30px; text-align: center; }
        .plan-card:hover { border-color: var(--primary); transform: translateY(-5px); }
        .plan-card.premium { border-color: var(--gold); }
        .plan-btn { width: 100%; padding: 12px; border-radius: 12px; font-weight: 700; cursor: pointer; border: 1px solid #333; background: transparent; color: white; margin-top: 15px; }
        .plan-btn:hover { background: var(--primary); border-color: var(--primary); }
        .qr-img { width: 100%; max-width: 250px; border-radius: 10px; margin: 0 auto 20px; display: block; border: 2px solid white; }

        @media (max-width: 768px) {
            .hero h1 { font-size: 2.5rem; }
            .res-top { flex-direction: column; align-items: center; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="void-stream" id="voidStream"></div>
    <div id="announcementBar"></div>

    <div class="modal-wrap" id="authModal">
        <div class="modal-box">
            <i class="fas fa-times" onclick="closeModal('authModal')" style="position:absolute; top:20px; right:20px; cursor:pointer; color:#555"></i>
            <h2 id="authTitle" style="margin-bottom:10px">Login</h2>
            <form id="authForm">
                <input type="text" id="userInput" class="modal-inp" placeholder="Username" required>
                <input type="email" id="emailInput" class="modal-inp" placeholder="Email" style="display:none;">
                <input type="password" id="passInput" class="modal-inp" placeholder="Password" required>
                <button type="submit" class="liquid-btn" style="width:100%; margin-top:15px">SUBMIT</button>
            </form>
            <p onclick="toggleAuthMode()" style="margin-top:20px; color:#888; cursor:pointer; font-size:0.9rem"><span id="authSwitchText">New User? Register</span></p>
            <p id="authMsg" style="color:red; margin-top:10px; font-size:0.8rem"></p>
        </div>
    </div>

    <div class="modal-wrap" id="paymentModal">
        <div class="modal-box">
            <i class="fas fa-times" onclick="closeModal('paymentModal')" style="position:absolute; top:20px; right:20px; cursor:pointer; color:#555"></i>
            <div id="stepScan">
                <h3>Scan to Pay</h3>
                <img src="qr.jpeg" class="qr-img" alt="QR Code">
                <p style="color:var(--gold); font-family:monospace; margin-bottom:15px">9369228920@fam</p>
                <button class="liquid-btn" style="width:100%" onclick="showUploadStep()">I made payment</button>
            </div>
            <div id="stepUpload" style="display:none">
                <h3>Verify Payment</h3>
                <form onsubmit="submitPayment(event)">
                    <input type="hidden" id="selectedPlanName">
                    <input type="file" id="proofFile" class="modal-inp" accept="image/*" required>
                    <button type="submit" class="liquid-btn" style="width:100%">UPLOAD PROOF</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal-wrap" id="planModal">
        <div class="modal-box">
            <i class="fas fa-times" onclick="closeModal('planModal')" style="position:absolute; top:20px; right:20px; cursor:pointer; font-size:1.5rem; color:white"></i>
            <h2 style="margin-bottom:30px; color:white">Get Credits</h2>
            <div class="pricing-grid">
                <div class="plan-card">
                    <h3>Booster</h3>
                    <h1 style="margin:10px 0">25 rs</h1>
                    <p style="color:#888; margin-bottom:15px">50 Credits</p>
                    <button class="plan-btn" onclick="openPaymentModal('Booster')">Select</button>
                </div>
                <div class="plan-card premium">
                    <h3>God Mode</h3>
                    <h1 style="margin:10px 0; color:var(--gold)">70 rs</h1>
                    <p style="color:#888; margin-bottom:15px">Unlimited Access</p>
                    <button class="plan-btn" style="border-color:var(--gold); color:var(--gold)" onclick="openPaymentModal('God Mode')">Select</button>
                </div>
            </div>
        </div>
    </div>

    <header>
        <div class="nav-container">
            <div class="logo"><i class="fab fa-instagram"></i> In.dl</div>
            <div class="user-nav">
                <div class="token-pill" onclick="checkLoginAndOpenPlan()"><i class="fas fa-coins"></i> <span id="tokenCount">...</span></div>
                <div id="userArea"></div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="hero">
            <h1>IG Media Saver</h1>
            <p>Download Reels, Stories, and Posts instantly.</p>
        </div>

        <div class="search-container">
            <div class="search-bar">
                <div class="paste-icon" onclick="pasteFromClipboard()"><i class="fas fa-paste"></i></div>
                <input type="text" class="url-inp" id="urlInput" placeholder="Paste Instagram link here...">
                <button class="go-btn" id="searchBtn" onclick="fetchInfo()"><i class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <div class="dark-card" id="resultCard">
            <div class="res-top">
                <img src="" class="res-img" id="resThumb">
                <div style="flex:1">
                    <h3 id="resTitle" style="margin-bottom:10px">Title</h3>
                    <div id="resMeta" style="color:#666">00:00</div>
                </div>
            </div>
            <div id="formatList"></div>
        </div>
    </div>

    <script>
        const API_URL = "/api";
        let authToken = localStorage.getItem('token');
        let isLoginMode = true;

        window.onload = () => { spawnParticles(); checkStatus(); };
        
        function spawnParticles() {
            const c = document.getElementById('voidStream');
            const icons = ['fa-camera', 'fa-video', 'fa-heart', 'fa-image'];
            for(let i=0; i<15; i++) {
                let el = document.createElement('i');
                el.className = `fas ${icons[Math.floor(Math.random()*icons.length)]} stream-icon`;
                el.style.left = Math.random()*100+'%';
                el.style.animationDuration = (Math.random()*5+10)+'s';
                el.style.animationDelay = Math.random()*5+'s';
                c.appendChild(el);
            }
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function checkLoginAndOpenPlan() {
            if(!authToken) return openModal('authModal');
            openModal('planModal');
        }

        function openPaymentModal(plan) {
            if(!authToken) return openModal('authModal');
            closeModal('planModal');
            document.getElementById('selectedPlanName').value = plan;
            document.getElementById('stepScan').style.display = 'block';
            document.getElementById('stepUpload').style.display = 'none';
            openModal('paymentModal');
        }

        function showUploadStep() {
            document.getElementById('stepScan').style.display = 'none';
            document.getElementById('stepUpload').style.display = 'block';
        }

        async function checkStatus() {
            try {
                const res = await fetch(`${API_URL}/status`, { headers: authToken ? {'Authorization': `Bearer ${authToken}`} : {} });
                const d = await res.json();
                
                if(d.announcement) {
                    const b = document.getElementById('announcementBar');
                    b.innerText = d.announcement; b.style.display = 'block';
                }
                
                document.getElementById('tokenCount').innerText = `${d.tokens}/${d.is_logged_in ? 'âˆž' : 5}`;
                
                let html = `<div class="profile-wrap"><div class="profile-btn" onclick="document.querySelector('.dropdown-menu').classList.toggle('show')"><i class="fas fa-user${d.is_logged_in?'-astronaut':''}"></i></div><div class="dropdown-menu"><div style="color:white; font-weight:bold">${d.username||'Guest'}</div>${d.is_admin ? '<a href="admin.html" style="color:white; display:block; padding:5px">Admin</a>' : ''}<button class="liquid-btn" style="width:100%; margin-top:10px; font-size:0.8rem" onclick="${d.is_logged_in?'doLogout()':"openModal('authModal')" }">${d.is_logged_in?'LOGOUT':'LOGIN'}</button></div></div>`;
                document.getElementById('userArea').innerHTML = html;
            } catch(e) {}
        }

        async function fetchInfo() {
            const url = document.getElementById('urlInput').value;
            const btn = document.getElementById('searchBtn');
            if(!url) return;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            try {
                const res = await fetch(`${API_URL}/info`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({url}) });
                const d = await res.json();
                if(d.error) throw new Error(d.error);
                
                document.getElementById('resThumb').src = d.thumbnail;
                document.getElementById('resTitle').innerText = d.title;
                document.getElementById('resMeta').innerText = d.duration;
                
                document.getElementById('formatList').innerHTML = d.formats.map(f => `
                    <div class="fmt-item">
                        <div><b>${f.quality}</b> <span style="color:#888">${f.ext.toUpperCase()}</span></div>
                        <button class="dl-mini-btn" onclick="startDownload('${url}', '${f.id}', this)">GET</button>
                    </div>
                `).join('');
                
                document.getElementById('resultCard').style.display = 'block';
            } catch(e) { alert("Error: "+e.message); }
            finally { btn.innerHTML = '<i class="fas fa-arrow-right"></i>'; }
        }

        async function startDownload(url, fmt, btn) {
            const org = btn.innerText;
            btn.innerText = '...'; btn.disabled = true;
            
            const headers = {'Content-Type':'application/json'};
            if(authToken) headers['Authorization'] = `Bearer ${authToken}`;
            
            try {
                const res = await fetch(`${API_URL}/download`, { method:'POST', headers, body: JSON.stringify({url, format_id:fmt}) });
                const d = await res.json();
                
                if(res.status !== 200) {
                    alert(d.message || d.error);
                    if(d.error === 'LIMIT_REACHED') {
                        authToken ? openModal('planModal') : openModal('authModal');
                    }
                    btn.innerText = org; btn.disabled = false;
                    return;
                }
                
                const timer = setInterval(async () => {
                    const p = await fetch(`${API_URL}/progress/${d.job_id}`).then(r=>r.json());
                    if(p.status === 'completed') {
                        clearInterval(timer);
                        btn.innerText = 'DONE';
                        window.location.href = `${API_URL}/file/${d.job_id}`;
                        checkStatus();
                    }
                }, 1000);
                
            } catch(e) { btn.innerText = 'ERR'; }
        }

        async function submitPayment(e) {
            e.preventDefault();
            const fd = new FormData();
            fd.append('plan_name', document.getElementById('selectedPlanName').value);
            fd.append('screenshot', document.getElementById('proofFile').files[0]);
            
            await fetch(`${API_URL}/payment/request`, { method:'POST', headers:{'Authorization':`Bearer ${authToken}`}, body:fd });
            alert("Submitted! Wait for approval.");
            closeModal('paymentModal');
        }

        async function pasteFromClipboard() {
            try { document.getElementById('urlInput').value = await navigator.clipboard.readText(); } catch(e){}
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.getElementById('authTitle').innerText = isLoginMode ? 'Login' : 'Register';
            document.getElementById('emailInput').style.display = isLoginMode ? 'none' : 'block';
            document.getElementById('authSwitchText').innerText = isLoginMode ? 'New User? Register' : 'Have Account? Login';
        }

        document.getElementById('authForm').onsubmit = async (e) => {
            e.preventDefault();
            const u = document.getElementById('userInput').value;
            const p = document.getElementById('passInput').value;
            const m = document.getElementById('emailInput').value;
            const ep = isLoginMode ? 'login' : 'register';
            const body = { username: u, password: p, email: m };
            
            const res = await fetch(`${API_URL}/${ep}`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
            const d = await res.json();
            
            if(res.ok) {
                if(isLoginMode) { localStorage.setItem('token', d.token); authToken=d.token; closeModal('authModal'); checkStatus(); }
                else { alert("Registered! Login now."); toggleAuthMode(); }
            } else {
                document.getElementById('authMsg').innerText = d.message;
            }
        };
        
        function doLogout() { localStorage.removeItem('token'); location.reload(); }
    </script>
</body>
</html>
